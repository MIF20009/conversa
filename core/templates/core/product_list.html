{% extends "core/base.html" %}
{% block title %}{{ business.name }} - Products{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-1">{{ business.name }} - Products</h3>
        <p class="text-muted mb-0">{{ products|length }} products</p>
    </div>
    <div class="d-none d-md-flex">
        <a class="btn btn-outline-brand me-2" href="{% url 'core:owner_dashboard' %}">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
        <a class="btn btn-primary-brand me-2" href="{% url 'core:product_create' business.id %}">
            <i class="bi bi-plus-circle"></i> Add Product
        </a>
        <a class="btn btn-secondary-brand" href="{% url 'core:product_import' business.id %}">
            <i class="bi bi-upload"></i> Import Excel
        </a>
    </div>
</div>

<div class="sticky-actions mb-4">
    <div class="row g-2 align-items-center">
        <div class="col-12 col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="search" class="form-control" placeholder="Search by name or SKU" aria-label="Search products" data-action="filter-products">
            </div>
        </div>
    </div>
    <div class="d-md-none mt-2">
        <a class="btn btn-outline-brand w-100" href="{% url 'core:owner_dashboard' %}"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>
    </div>
</div>

{% if products %}
    <div class="card">
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>SKU</th>
                        <th>Category</th>
                        <th>Price (USD)</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td class="fw-semibold">{{ product.name }}</td>
                        <td>{{ product.sku|default:'—' }}</td>
                        <td>{{ product.category.name|default:'—' }}</td>
                        <td>${{ product.price_usd }}</td>
                        <td>{{ product.stock }}</td>
                        <td>
                            {% if product.active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'core:product_edit' business.id product.id %}" class="btn btn-outline-primary" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'core:product_detail' business.id product.id %}" class="btn btn-outline-secondary" title="Info">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                                <button type="button" class="btn btn-outline-danger" title="Delete" 
                                        onclick="showDeleteModal('{{ product.id }}', '{{ product.name|escapejs }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% else %}
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="bi bi-box display-1 text-muted"></i>
        </div>
        <h4 class="text-muted">No Products Yet</h4>
        <p class="text-muted">Start by adding your first product or importing from Excel.</p>
        <div class="mt-4">
            <a class="btn btn-primary-brand me-2" href="{% url 'core:product_create' business.id %}">
                <i class="bi bi-plus-circle"></i> Add First Product
            </a>
            <a class="btn btn-secondary-brand" href="{% url 'core:product_import' business.id %}">
                <i class="bi bi-upload"></i> Import from Excel
            </a>
        </div>
    </div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product?</p>
                <p class="fw-bold" id="productNameToDelete"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">Product Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="">
            </div>
        </div>
    </div>
</div>
<script>
function showImageModal(imageUrl, productName) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('imageModalTitle').textContent = productName;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

function showDeleteModal(productId, productName) {
    document.getElementById('productNameToDelete').textContent = productName;
    document.getElementById('deleteForm').action = '{% url "core:product_delete" business.id 0 %}'.replace('/0/', '/' + productId + '/');
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// Product search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('[data-action="filter-products"]');
    const productRows = document.querySelectorAll('tbody tr');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            productRows.forEach(function(row) {
                const productName = row.querySelector('td:first-child').textContent.toLowerCase();
                const productSku = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const productCategory = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                // Search in name, SKU, and category
                const matches = productName.includes(searchTerm) || 
                              productSku.includes(searchTerm) || 
                              productCategory.includes(searchTerm);
                
                if (matches || searchTerm === '') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update product count and show/hide no results message
            const visibleRows = Array.from(productRows).filter(row => row.style.display !== 'none');
            const productCountElement = document.querySelector('.text-muted.mb-0');
            if (productCountElement) {
                productCountElement.textContent = `${visibleRows.length} products`;
            }
            
            // Show/hide no results message
            let noResultsMessage = document.getElementById('no-results-message');
            if (visibleRows.length === 0 && searchTerm !== '') {
                if (!noResultsMessage) {
                    noResultsMessage = document.createElement('div');
                    noResultsMessage.id = 'no-results-message';
                    noResultsMessage.className = 'text-center py-4';
                    noResultsMessage.innerHTML = '<i class="bi bi-search display-4 text-muted"></i><h5 class="text-muted mt-2">No products found</h5><p class="text-muted">Try adjusting your search terms</p>';
                    document.querySelector('.table-responsive').parentNode.appendChild(noResultsMessage);
                }
                noResultsMessage.style.display = 'block';
            } else if (noResultsMessage) {
                noResultsMessage.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}